<template>
    <div class="p-6 max-w-4xl mx-auto" dir="rtl">
      <h1 class="text-3xl font-bold mb-6 text-center">ุงุฎุชูุงุฑ ุงูุฑุบุจุงุช ุงูุฌุงูุนูุฉ</h1>
    <!-- ๐ ุชูุจููุงุช ูุชุนูููุงุช -->
<div class="bg-red-100 border border-red-400 text-red-800 p-4 rounded mb-6 text-sm leading-relaxed">
  <ul class="list-disc pr-4 text-right space-y-2">
    <li>โ๏ธ <strong>ูู ุญุงู ุชู ุงุณุชุฎุฑุงุฌ ุฑูู ุงูุงุณุชูุงุฑุฉ:</strong> ุงูุฑุฌุงุก ุนุฏู ุชูุฏูู ุทูุจ ุฌุฏูุฏุ ูุชูุงุตู ูุนูุง ุจุฏูุงู ูู ุฐูู.</li>
    <li>๐ <strong>ุงูุชุจ ุฑูู ูุงุชู ุตุญูุญ:</strong> ููุถู ุฃู ูููู ููุนูู ุจู ูุงุชุณุงุจ ุฅุฐุง ูู ููู ูุนูู ููููุงููุงุช.</li>
    <li>๐ซ <strong>ุงูุงุณุชูุงุฑุฉ ุงูููุฏูุฉ ูุง ูููู ุชุนุฏูููุง ุฃู ุงูุชุฑุงุฌุน ุนููุง:</strong> ุฅุฐุง ูุงู ููุงู ุฎุทุฃุ ุชูุงุตู ูุนูุง ูุจู ุงููุงู ุนูููู ุงูุชูุฏูู ".</li>
    <li>๐ต <strong>ุงูุฏูุน ูุฑูุน ุดุนุงุฑ ุจููู:</strong> ูุชู ุจุงูุชุฒุงูู ูุน ุงูุชูุฏูู ูุจุนุฏ ุงูุชุฃููุฏ ูุจุฏุฃ ุงูุนูู ูุจุงุดุฑุฉ.</li>
    <li>๐ <strong>ูุฑุงุญู ุงูุทูุจ:</strong> 
      <ul class="list-disc pr-4 mt-1 text-gray-700 text-sm">
        <li><strong>ุฌุงุฑู ุงููุญุต:</strong> ุงูุทูุจ ุชุญุช ุงููุฑุงุฌุนุฉ ุงูุฃูููุฉ.</li>
        <li><strong>ุฌุงุฑู ุงูุทูุจ:</strong> ุงูุทูุจ ููุฏ ุงูุชูููุฐ ูุงูุชูุฏูู.</li>
        <li><strong>ุชู ุงูุทูุจ:</strong> ุชู ุฅููุงู ุงูุชูุฏูู ุจูุฌุงุญ.</li>
        <li><strong>ูุฑููุถ:</strong> ูู ูุชู ูุจูู ุงูุทูุจ (ุฑุงุฌุน ุงูุณุจุจ ูุน ุงููุณุคูู).</li>
      </ul>
    </li>
  </ul>
</div>
<!-- ๐ ุทุฑู ุงูุชูุงุตู -->
<div class="bg-green-50 border border-green-400 text-green-800 p-4 rounded mb-6 text-sm leading-relaxed">
  <p class="mb-2 font-semibold">ููุงุณุชูุณุงุฑุงุช ุฃู ูุฌูุฏ ุฃู ูุดููุฉ ููููู ุงูุชูุงุตู ูุนูุง ุนุจุฑ:</p>
  <div class="flex flex-col md:flex-row gap-4 rtl:space-x-reverse">
    <!-- ุฒุฑ ูุงุชุณุงุจ -->
    <a
      href="https://wa.me/249907452551"
      target="_blank"
      class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-center w-full md:w-auto"
    >
      ๐ฌ ูุงุชุณุงุจ: 0907452551
    </a>

    <!-- ุฒุฑ ุชูููุฌุฑุงู -->
    <a
      href="https://t.me/MhmdAdl52"
      target="_blank"
      class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-center w-full md:w-auto"
    >
      ๐ฌ ุชูููุฌุฑุงู: @MhmdAdl52
    </a>

    <!-- ุฒุฑ ููุงููุฉ -->
    <a
      href="tel:+249907452551"
      class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800 text-center w-full md:w-auto"
    >
      ๐ ุงุชุตุงู ูุจุงุดุฑ: 0907452551
    </a>
  </div>
</div>


      <div class="mb-4">
  <label class="block mb-2 font-medium">ุงุณู ุงูุทุงูุจ:</label>
  <input v-model="studentName" type="text" class="p-2 border rounded w-full" placeholder="ุฃุฏุฎู ุงุณูู" />
</div>

<!-- ุฑูู ุงููุงุชู -->
<div class="mb-4">
  <label class="block mb-2 font-medium">ุฑูู ุงููุงุชู:</label>
  <input v-model="studentPhone" type="text" class="p-2 border rounded w-full" placeholder="ุฃุฏุฎู ุฑูู ุงููุงุชู" />
</div>

<!-- ุฑูู ุงูุฌููุณ -->
<div class="mb-4">
  <label class="block mb-2 font-medium">ุฑูู ุงูุฌููุณ:</label>
  <input v-model="studentSeatNumber" type="text" class="p-2 border rounded w-full" placeholder="ุฃุฏุฎู ุฑูู ุงูุฌููุณ" />
</div> 
      <!-- ุงุฎุชูุงุฑ ุงูุฌุงูุนุฉ -->
      <div class="mb-4">
        <label class="block mb-2 font-medium">ุงุฎุชุฑ ุงูุฌุงูุนุฉ:</label>
        <select v-model="selectedUniversity" @change="fetchFaculties" class="p-2 border rounded w-full">
          <option disabled value="">-- ุงุฎุชุฑ ุฌุงูุนุฉ --</option>
          <option v-for="university in universities" :key="university.name" :value="university.name">
            {{ university.name }}
          </option>
        </select>
      </div>
  
      <!-- ุงุฎุชูุงุฑ ุงููููุฉ -->
      <div v-if="faculties.length" class="mb-4">
        <label class="block mb-2 font-medium">ุงุฎุชุฑ ุงููููุฉ:</label>
        <select v-model="selectedFaculty" class="p-2 border rounded w-full">
          <option disabled value="">-- ุงุฎุชุฑ ูููุฉ --</option>
          <option v-for="faculty in faculties" :key="faculty" :value="faculty">
            {{ faculty }}
          </option>
        </select>
        <button
          @click="addPreference"
          class="mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-4 rounded"
          :disabled="!selectedFaculty || preferences.length >= 45"
        >
          ุฅุถุงูุฉ
        </button>
        <p v-if="errorMessage" class="text-red-600 mt-2">{{ errorMessage }}</p>
      </div>
  
      <!-- ุฌุฏูู ุงูุฑุบุจุงุช -->
      <div v-if="preferences.length" class="mb-6">
        <h2 class="text-xl font-semibold mb-2">ุงูุฑุบุจุงุช ุงููุฎุชุงุฑุฉ:</h2>
        <table class="w-full table-auto border border-gray-300">
  <thead>
    <tr class="bg-gray-100">
      <th class="border p-2">#</th>
      <th class="border p-2">ุงูุฌุงูุนุฉ</th>
      <th class="border p-2">ุงููููุฉ</th>
      <th class="border p-2">ุชุญุฑูู</th>
      <th class="border p-2">ุญุฐู</th>
    </tr>
  </thead>
  <tbody>
    <tr v-for="(pref, index) in preferences" :key="index">
      <td class="border p-2 text-center">{{ index + 1 }}</td>
      <td class="border p-2">{{ pref.university }}</td>
      <td class="border p-2">{{ pref.faculty }}</td>

      <!-- ุฃุฒุฑุงุฑ ุงูุชุญุฑูู -->
      <td class="border p-2 text-center space-x-1 rtl:space-x-reverse">
        <button
          @click="moveUp(index)"
          :disabled="index === 0"
          class="text-blue-600 disabled:opacity-30"
        >โฌ๏ธ</button>
        <button
          @click="moveDown(index)"
          :disabled="index === preferences.length - 1"
          class="text-blue-600 disabled:opacity-30"
        >โฌ๏ธ</button>
      </td>

      <!-- ุฒุฑ ุงูุญุฐู -->
      <td class="border p-2 text-center">
        <button @click="removePreference(index)" class="text-red-500">๐๏ธ</button>
      </td>
    </tr>
  </tbody>
</table>

      </div>
  
      <!-- ุฒุฑ ุงูุชูุฏูู -->
      <!-- ุฒุฑ ุงูุชูุฏูู -->
      
<div v-if="preferences.length >= 2" class="text-center mt-4">
  <button
    @click="submitPreferences"
    class="bg-green-600 text-white py-2 px-6 rounded hover:bg-green-700"
  >
    ุชูุฏูู
  </button>
</div>

    </div>
  </template>
  
  <script>
  import PreferenceService from '../../services/preference.service';

  import { jsPDF } from "jspdf";
  import { amiriBase64 } from "@/fonts/amiri"; // ุงุณุชุฏุนุงุก ุงูุฎุท ูู ููู ุฎุงุฑุฌู
  export default {
    mounted() {

},
watch: {
  preferences: {
    handler() {
      localStorage.setItem('studentPrefs', JSON.stringify({
        studentName: this.studentName,
        preferences: this.preferences
      }));
    },
    deep: true
  }
} ,
    data() {
      return {
            studentName: "",
    studentPhone: "",
    studentSeatNumber: "",
        universities: [
          {
            name: "ุฌุงูุนุฉ ุงูุฎุฑุทูู",
            faculties: ["ุงูุทุจ", "ุงูููุฏุณุฉ", "ุงููุงููู", "ุงูุขุฏุงุจ"]
          },
          {
            name: "ุฌุงูุนุฉ ุงูุณูุฏุงู",
            faculties: ["ุงูุญุงุณูุจ", "ุงูุฅุนูุงู", "ุงูุนููู", "ุงูุงูุชุตุงุฏ"]
          },
          {
            name: "ุฌุงูุนุฉ ุงูุฌุฒูุฑุฉ",
            faculties: ["ุงูุฒุฑุงุนุฉ", "ุงูุทุจ", "ุงูุจูุทุฑุฉ", "ุงูุตูุฏูุฉ"]
          }
        ],
        selectedUniversity: "",
        selectedFaculty: "",
        faculties: [],
        preferences: [],
        errorMessage: ""
      };
    },
    methods: {
      fetchFaculties() {
        const uni = this.universities.find(u => u.name === this.selectedUniversity);
        this.faculties = uni ? uni.faculties : [];
        this.selectedFaculty = "";
        this.errorMessage = "";
      },

   async   submitPreferences() {
  if (this.preferences.length < 1) {
    alert("ูุฌุจ ุงุฎุชูุงุฑ 10 ุฑุบุจุงุช ุนูู ุงูุฃูู");
    return;
  }
  if (!this.studentName.trim()) {
    alert("ุงูุฑุฌุงุก ุฅุฏุฎุงู ุงุณู ุงูุทุงูุจ.");
    return;
  }
  const stored = JSON.parse(localStorage.getItem('user'));
  const userId = stored?.user?.id;

  if (!userId) {
    alert("ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุงูุฏุฎูู.");
    return;
  }

  try {
    await PreferenceService.submit({
      studentName: this.studentName,
      phone: this.studentPhone,
      seatNumber: this.studentSeatNumber,
      preferences: this.preferences
    });

    alert("โ ุชู ุฅุฑุณุงู ุงูุฑุบุจุงุช ุจูุฌุงุญ ุฅูู ุงูุณูุฑูุฑ!");
    this.preferences = [];
  } catch (error) {
    console.error("ูุดู ุงูุฅุฑุณุงู:", error);
    alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฅุฑุณุงู. ุชุฃูุฏ ูู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ.");
  }
  const doc = new jsPDF();

  // ุงูุณุฎ base64 ููุฎุท ููุง
  

  // ุฃุถู ุงูุฎุท ุฅูู jsPDF
  doc.addFileToVFS("Amiri-Regular.ttf", amiriBase64);
  doc.addFont("Amiri-Regular.ttf", "Amiri", "normal");
  doc.setFont("Amiri");
  doc.setFontSize(14);

  // โ ุงูุนููุงู ูุงุณู ุงูุทุงูุจ
  doc.text("ูุงุฆูุฉ ุงูุฑุบุจุงุช ุงูุฌุงูุนูุฉ", 105, 20, { align: "center" , underline: true });
  const dateStr = new Date().toLocaleDateString("ar-EG", {
    year: "numeric",
    month: "long",
    day: "numeric"
  });
  doc.text(`ุงูุชุงุฑูุฎ: ${dateStr}`, 10, 30, { align: "left" });
  doc.text(`ุงุณู ุงูุทุงูุจ: ${this.studentName}`, 190, 30, { align: "right" });
  
  // โ ุงูุฑุบุจุงุช ูุน ุชุฑุชูุจ ุตุญูุญ
  let y = 50;
  this.preferences.forEach((pref, index) => {
      const num = `/${index + 1}`;
      const text = `${pref.university} - ${pref.faculty}`;
      

      doc.text(num, 180, y, { align: "right" });    // ุงูุฑูู
      doc.text(text, 170, y, { align: "right" });   // ุงููุต
      y += 10;
      if (y > 280) {
          doc.addPage();
          y = 20;
        }
    });
    doc.setFontSize(12);
  doc.text("ุฌุงุฑู ุงูุชูุฏูู ุฑุงุฌุน ูููู ููุญุตูู ุนูู ุงูุตูุฑุฉ ุงูููุงุฆูุฉ.", 105, y + 10, { align: "center" });

  doc.save(`${this.studentName}.pdf`);
}

 ,
      addPreference() {
        this.errorMessage = "";
  
        const exists = this.preferences.some(
          pref => pref.university === this.selectedUniversity && pref.faculty === this.selectedFaculty
        );
  
        if (exists) {
          this.errorMessage = "ุชู ุงุฎุชูุงุฑ ูุฐู ุงููููุฉ ูู ูุจู.";
          return;
        }
  
        if (this.preferences.length < 45) {
          this.preferences.push({
            university: this.selectedUniversity,
            faculty: this.selectedFaculty
          });
          this.selectedFaculty = "";
        }
      },
      removePreference(index) {
        this.preferences.splice(index, 1);
      },
      moveUp(index) {
        if (index > 0) {
          const temp = this.preferences[index];
          this.preferences.splice(index, 1);
          this.preferences.splice(index - 1, 0, temp);
        }
      },
      moveDown(index) {
        if (index < this.preferences.length - 1) {
          const temp = this.preferences[index];
          this.preferences.splice(index, 1);
          this.preferences.splice(index + 1, 0, temp);
        }
      }
    }
  };
  </script>
  
  <style>
  body {
    font-family: 'Cairo', sans-serif;
  }
  </style>
  